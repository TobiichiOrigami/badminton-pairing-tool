<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>隨機分組對戰</title>
  <!-- 引入 Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>

<body>
  <div class="container my-4">
    <h3 class="text-center mb-4">選擇球員進行抽籤</h3>
    <form id="playersForm">
      <div class="mb-3">
        <label for="newPlayer" class="form-label">新增球員：</label>
        <input type="text" id="newPlayer" class="form-control" placeholder="輸入新球員名稱">
      </div>
      <button type="button" class="btn btn-primary mb-3" onclick="addPlayer()">新增</button>

      <div class="row g-2">
        <button type="button" class="btn btn-outline-primary position-relative" data-bs-toggle="collapse" data-bs-target="#advancedOptions"
          aria-expanded="false" aria-controls="advancedOptions">
          進階選項
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="advancedOptionsBadge">
            2
          </span>
        </button>
        <div class="collapse" id="advancedOptions">
          <div class="col">
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-red" id="autoPriority" checked>
            自動優先</label>
            <span class="badge rounded-pill bg-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="right" data-bs-content="啟用本項，會自動於隨機分組後，勾選最後一場未出戰球員的優先選項">?</span>
          </div>
          <div class="col">
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-green" id="noBindCheck" checked>
            優先不必同組</label>
            <span class="badge rounded-pill bg-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="right" data-bs-content="啟用本項，可避免優先球員為兩位時，自動被分為同一組">?</span>
          </div>
          <div class="col">
            <button type="button" class="btn btn-warning mb-4" onclick="removeAllPlayers()">移除所有球員卡</button>
            <span class="badge rounded-pill bg-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="right" data-bs-content="點擊本按鈕可移除所有球員卡，以避免因新增球員過多，使版面雜亂">?</span>
          </div>
        </div>
      </div>

      <hr/>

      <div class="row row-cols-3 g-2">
        <div class="col">
          <label class="form-check-label"><input type="checkbox" class="form-check-input" id="selectAll""> 全選 </label>
        </div>
        <div class="col">
          <button type="button" class="btn btn-danger mb-4" onclick="removePriority()">移除優先</button>
        </div>
      </div>

      <div class="mb-3 row row-cols-3 row-cols-sm-3 row-cols-md-6 g-2" id="player-list">
          <div class="col card"><label class="form-check-label"><input type="checkbox" class="form-check-input player"
                id="player1" value="博翰"> 博翰</label>
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-red priority"
                id="player1-priority" value="博翰"> 優先</label>
          </div>
          <div class="col card"><label class="form-check-label"><input type="checkbox" class="form-check-input player"
                id="player2" value="士賢"> 士賢</label>
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-red priority"
                id="player2-priority" value="士賢"> 優先</label>
          </div>
          <div class="col card"><label class="form-check-label"><input type="checkbox" class="form-check-input player"
                id="player3" value="瑞文"> 瑞文</label>
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-red priority"
                id="player3-priority" value="瑞文"> 優先</label>
          </div>
          <div class="col card"><label class="form-check-label"><input type="checkbox" class="form-check-input player"
                id="player4" value="文凱"> 文凱</label>
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-red priority"
                id="player4-priority" value="文凱"> 優先</label>
          </div>
          <div class="col card"><label class="form-check-label"><input type="checkbox" class="form-check-input player"
                id="player5" value="楊偉"> 楊偉</label>
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-red priority"
                id="player5-priority" value="楊偉"> 優先</label>
          </div>
          <div class="col card"><label class="form-check-label"><input type="checkbox" class="form-check-input player"
                id="player6" value="同偉"> 同偉</label>
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-red priority"
                id="player6-priority" value="同偉"> 優先</label>
          </div>
          <div class="col card"><label class="form-check-label"><input type="checkbox" class="form-check-input player"
                id="player7" value="家崴"> 家崴</label>
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-red priority"
                id="player7-priority" value="家崴"> 優先</label>
          </div>
          <div class="col card"><label class="form-check-label"><input type="checkbox" class="form-check-input player"
                id="player8" value="學長"> 學長</label>
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-red priority"
                id="player8-priority" value="學長"> 優先</label>
          </div>
          <div class="col card"><label class="form-check-label"><input type="checkbox" class="form-check-input player"
                id="player9" value="學姊"> 學姊</label>
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-red priority"
                id="player9-priority" value="學姊"> 優先</label>
          </div>
          <div class="col card"><label class="form-check-label"><input type="checkbox" class="form-check-input player"
                id="player10" value="國鋒"> 國鋒</label>
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-red priority"
                id="player10-priority" value="國鋒"> 優先</label>
          </div>
          <div class="col card"><label class="form-check-label"><input type="checkbox" class="form-check-input player"
                id="player11" value="阿呆"> 阿呆</label>
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-red priority"
                id="playe11-priority" value="阿呆"> 優先</label>
          </div>
          <div class="col card"><label class="form-check-label"><input type="checkbox" class="form-check-input player"
                id="player12" value="煥呈"> 煥呈</label>
            <label class="form-check-label"><input type="checkbox" class="form-check-input check-red priority"
                id="player12-priority" value="煥呈"> 優先</label>
          </div>
      </div>
    </form>

    <button type="button" class="btn btn-success mb-4" onclick="generateTeams()">隨機分組</button>
    <div id="result" class="border p-3 rounded"></div>
    
  </div>

  <script>

    document.addEventListener('DOMContentLoaded', function () {
      // 全選/取消全選功能
      document.getElementById('selectAll').addEventListener('change', function () {
        const checkboxes = document.querySelectorAll('#player-list input.player');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });

      // 監聽進階選項變更以更新徽章數字
      document.getElementById('autoPriority').addEventListener('change', updateAdvancedOptionsBadge);
      document.getElementById('noBindCheck').addEventListener('change', updateAdvancedOptionsBadge);

      // 初始化所有帶有 data-bs-toggle="popover" 屬性的元素
      const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
      const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));
    });

    // 新增球員並生成核取方塊
    function addPlayer() {
      const input = document.getElementById('newPlayer').value.trim();
      if (!input) return;

      const names = input.split(',').map(name => name.trim()).filter(name => name);
      const playerList = document.getElementById('player-list');

      names.forEach(name => {
        const div = document.createElement('div');
        div.classList.add('col');
        div.classList.add('card');

        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" class="form-check-input player" value="${name}" checked> ${name}`;

        const labelPriority = document.createElement('label');
        labelPriority.innerHTML = `<input type="checkbox" class="form-check-input check-red priority" value="${name}"> 優先`;

        div.appendChild(label)
        div.appendChild(labelPriority)
        playerList.appendChild(div);
      });

      document.getElementById('newPlayer').value = '';
    }

    // 隨機分組邏輯
    function generateTeams() {
      const checkboxes = document.querySelectorAll('#player-list input.player:checked');
      let players = Array.from(checkboxes).map(checkbox => checkbox.value);

      const priorityCheckboxes = document.querySelectorAll('#player-list input.priority:checked');
      let priorityPlayers = Array.from(priorityCheckboxes).map(checkbox => checkbox.value);

      // 剔除不在選中球員中的優先球員
      priorityPlayers = priorityPlayers.filter(p => players.includes(p));

      // 優先球員洗牌
      shuffleArray(priorityPlayers)

      // 非優先球員洗牌
      shuffleArray(players)

      // 將優先球員放在前面
      players = priorityPlayers.concat(players.filter(p => !priorityPlayers.includes(p)));

      const noBind = document.getElementById('noBindCheck').checked;
      if (noBind) {
        // 前4個球員再次洗牌以避免優先同組
        const firstFour = players.slice(0, 4);
        shuffleArray(firstFour);
        players = firstFour.concat(players.slice(4));
      }

      var teams = []
      var unusedPlayers = []
      for (let i = 0; i < players.length; i += 4) {
        var chunk = players.slice(i, i + 4)
        if (chunk.length == 4) {
          teams.push(chunk);
        } else {
          unusedPlayers.push(...chunk);
        }
      }

      if (players.length % 4 != 0) {
        var usedPlayers = teams.flat()
        shuffleArray(usedPlayers)
        unusedPlayers.push(...usedPlayers)
        teams.push(unusedPlayers.slice(0, 4))
      }

      // 顯示分組結果
      displayResults(teams);

      // 自動優先
      const autoPriority = document.getElementById('autoPriority').checked;
      if (autoPriority) {
        if(players.length >= 4) {
          // 挑出除了最後 4 個球員之外的列表
          const selectablePlayers = players.filter(p => !teams[teams.length - 1].includes(p));

          removePriority();

          // 將這些球員的優先選項勾起
          selectablePlayers.forEach(name => {
            const priorityCheckbox = document.querySelector(`#player-list input.priority[value="${name}"]`);
            if (priorityCheckbox) {
              priorityCheckbox.checked = true;
            }
          });
        }
      }
    }

    // 顯示分組結果
    function displayResults(teams) {
      let resultHtml = '';
      let groupIndex = 1;
      for (let i = 0; i < teams.length; i++) {
        resultHtml += `<p>組合 ${groupIndex++}: ${teams[i].slice(0, 2).join(' 跟 ')} 對 組合 ${groupIndex++}: ${teams[i].slice(2, 4).join(' 跟 ')}</p>`;
      }
      document.getElementById('result').innerHTML = resultHtml;
    }

    // 隨機打亂數組
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // 移除優先
    function removePriority() {
      const priorityCheckboxes = document.querySelectorAll('#player-list input.priority:checked');
      priorityCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
    }

    // 移除所有球員卡
    function removeAllPlayers() {
      const playerList = document.getElementById('player-list');
      playerList.innerHTML = '';
    }

    // 更新進階選項徽章數字
    function updateAdvancedOptionsBadge() {
      let count = 0;
      if (document.getElementById('autoPriority').checked) count++;
      if (document.getElementById('noBindCheck').checked) count++;

      const badge = document.getElementById('advancedOptionsBadge');
      badge.textContent = count;
    }
  </script>
  <!-- 引入 Bootstrap 的 JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>